<!-- Lo importante comienza desde la etiqueta <script> -->
<script>
  const roomsContainer = document.getElementById("rooms");
  const searchInput = document.getElementById("searchInput");
  const roomsData = [];

  const extraInfoHTML = `
    <div class="ml-4 text-sm space-y-1 max-w-xs">
      <p class="font-bold text-green-400">GANA $50 CON $0,50</p>
      <p>3 ENTRE 200 | ¬°Bienvenido! al Sorteo por Participacion en donde tendr√°s 3 Oportunidades para ¬°GANAR!</p>
      <p class="font-semibold">>>SER√ÅN 3 GIROS<<</p>
      <p>GIRO1Ô∏è‚É£ $10</p>
      <p>GIRO2Ô∏è‚É£ $10</p>
      <p>GIRO3Ô∏è‚É£ $50 üèÜ</p>
      <p class="font-bold">¬°QUE GANE EL MEJOR!</p>
    </div>
  `;

  function createRoom(id, participants = 0) {
    const room = document.createElement("div");
    room.className = "bg-gray-700 rounded-xl p-4 shadow-xl room";
    room.setAttribute("data-id", id);
    room.setAttribute("data-participants", participants);

    room.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-bold flex items-center gap-2">Sala #${id}</h3>
        ${extraInfoHTML}
      </div>
      <p>Participantes: <span class="participant-count">${participants}</span> / 200</p>
      <button onclick="connectWallet(${id})" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Unirse por $0.50</button>
      <iframe
        id="wheel-${id}"
        src="https://wheelofnames.com/bh2-bm6"
        width="400"
        height="400"
        style="margin-top:20px; border-radius: 12px; border: 2px solid #4ade80;"
      ></iframe>
    `;

    roomsContainer.appendChild(room);
    roomsData.push({ id, participants });
  }

  function populateRooms() {
    for (let i = 1; i <= 10; i++) {
      const randomParticipants = (i === 1) ? 41 : Math.floor(Math.random() * 200);
      if (randomParticipants < 200) {
        createRoom(i, randomParticipants);
      }
    }
  }

  function connectWallet(roomId) {
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.request({ method: 'eth_requestAccounts' })
        .then(accounts => {
          const wallet = accounts[0];
          alert(`Wallet conectada: ${wallet}\n¬°Te has unido a la Sala #${roomId}!`);

          // Incrementar participantes
          const roomEl = document.querySelector(`.room[data-id='${roomId}']`);
          const participantEl = roomEl.querySelector(".participant-count");
          let newCount = parseInt(participantEl.textContent) + 1;
          participantEl.textContent = newCount;

          // Si lleg√≥ a 200, activar la rueda
          if (newCount >= 200) {
            const iframe = roomEl.querySelector("iframe");
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage({ spin: true }, "*");
              alert("üéâ ¬°La sala est√° llena! La rueda est√° girando autom√°ticamente.");
            }
          }
        })
        .catch(err => {
          alert('Error al conectar wallet: ' + err.message);
        });
    } else {
      alert('Por favor instala MetaMask para unirte.');
    }
  }

  searchInput.addEventListener("input", (e) => {
    const value = e.target.value.toLowerCase();
    document.querySelectorAll(".room").forEach(room => {
      const roomId = room.getAttribute("data-id");
      room.style.display = roomId.includes(value) ? "block" : "none";
    });
  });

  populateRooms();
</script>
