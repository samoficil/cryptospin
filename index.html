<!-- Proyecto: CryptoSpin - Plataforma de Sorteos con CriptoPagos -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoSpin - Sorteos en Cripto</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Rueda */
    #wheel {
      border: 8px solid #444;
      border-radius: 50%;
      width: 300px;
      height: 300px;
      margin: auto;
      position: relative;
      overflow: hidden;
      background: conic-gradient(
        #FFD700 0deg 72deg, 
        #FF4500 72deg 144deg, 
        #1E90FF 144deg 216deg, 
        #32CD32 216deg 288deg, 
        #FFD700 288deg 360deg);
      transition-timing-function: cubic-bezier(0.33, 1, 0.68, 1);
    }
    #pointer {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 30px solid #ffdd00;
      z-index: 10;
    }
    #spinButton {
      background: #22c55e;
      color: white;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin: 20px auto 0 auto;
      display: block;
      transition: background-color 0.3s ease;
    }
    #spinButton:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }
    .winner-anim {
      animation: applause 2s ease forwards;
      font-size: 1.5rem;
      color: #facc15;
      font-weight: 700;
      margin-top: 10px;
      text-align: center;
    }
    @keyframes applause {
      0% {opacity: 0; transform: scale(0.8);}
      50% {opacity: 1; transform: scale(1.2);}
      100% {opacity: 1; transform: scale(1);}
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <header class="p-4 bg-gray-800 text-center text-3xl font-bold">
    CryptoSpin ðŸŽ°
  </header>

  <main class="flex-grow p-6 max-w-6xl mx-auto">

    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-3">Salas Disponibles</h2>
      <input type="text" id="searchInput" placeholder="Buscar sala por nÃºmero..." class="w-full p-2 rounded text-black mb-4" />

      <div id="rooms" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Salas se agregan dinÃ¡micamente aquÃ­ -->
      </div>
    </section>

    <section id="roomDetail" class="hidden p-6 bg-gray-800 rounded-xl shadow-xl max-w-md mx-auto text-center">
      <h3 id="roomTitle" class="text-2xl font-bold mb-4"></h3>
      <p>Participantes: <span id="participantCount"></span> / 200</p>

      <div id="wheelContainer" class="my-6 relative">
        <div id="pointer"></div>
        <div id="wheel"></div>
      </div>

      <button id="spinButton" disabled>Girar rueda</button>

      <div id="winnerAnnounce" class="mt-4"></div>

      <button id="backToRooms" class="mt-6 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Volver a Salas</button>
    </section>

    <section class="mt-12">
      <h2 class="text-xl font-semibold mb-3">Tabla de Ganadores</h2>
      <table class="w-full text-left border-collapse border border-gray-700">
        <thead>
          <tr class="bg-gray-700">
            <th class="border border-gray-600 p-2">Sala</th>
            <th class="border border-gray-600 p-2">Ganador</th>
            <th class="border border-gray-600 p-2">Premio</th>
            <th class="border border-gray-600 p-2">Fecha</th>
          </tr>
        </thead>
        <tbody id="winnersTableBody">
          <!-- Ganadores se agregan dinÃ¡micamente -->
        </tbody>
      </table>
    </section>

  </main>

  <footer class="p-4 bg-gray-800 text-center">
    &copy; 2025 CryptoSpin. Todos los derechos reservados.
  </footer>

  <script>
    // Datos y configuraciÃ³n base
    const MAX_PARTICIPANTS = 200;
    const ENTRY_COST = 0.50; // dÃ³lares
    const PRIZES = [10, 10, 50]; // premios de los 3 giros
    const SPIN_DELAY = 7000; // ms entre giros
    const WINNER_DISPLAY_TIME = 7000; // ms para mostrar ganador antes de siguiente giro

    // Salas con participantes
    const rooms = [];
    const winners = []; // historial ganadores para tabla

    // Estado actual
    let currentRoom = null;
    let spinCount = 0;
    let spinning = false;

    // Crear las 10 salas iniciales
    function createRooms() {
      for (let i = 1; i <= 10; i++) {
        rooms.push({ id: i, participants: 0, participantsList: [] });
      }
    }

    // Render salas visibles segÃºn bÃºsqueda
    function renderRooms(filter = "") {
      const container = document.getElementById("rooms");
      container.innerHTML = "";

      let filteredRooms = rooms.filter(room => room.id.toString().includes(filter));

      // Mostrar salas que no estÃ©n llenas y ordenadas por participantes descendente
      filteredRooms = filteredRooms.filter(r => r.participants < MAX_PARTICIPANTS);
      filteredRooms.sort((a, b) => b.participants - a.participants);

      for (const room of filteredRooms) {
        const div = document.createElement("div");
        div.className = "bg-gray-700 rounded-xl p-4 shadow-xl room cursor-pointer hover:bg-gray-600";
        div.innerHTML = `
          <h3 class="text-lg font-bold mb-2">Sala #${room.id}</h3>
          <p>Participantes: <span>${room.participants}</span> / ${MAX_PARTICIPANTS}</p>
          <button class="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full" onclick="joinRoom(${room.id})">Unirse por $${ENTRY_COST.toFixed(2)}</button>
        `;
        container.appendChild(div);
      }

      if(filteredRooms.length === 0) {
        container.innerHTML = "<p class='text-center text-gray-400'>No hay salas disponibles para unirse.</p>";
      }
    }

    // Filtrar salas con input
    document.getElementById("searchInput").addEventListener("input", e => {
      renderRooms(e.target.value);
    });

    // FunciÃ³n para unirse a sala
    function joinRoom(id) {
      if (spinning) {
        alert("Espera a que termine el giro actual.");
        return;
      }
      const room = rooms.find(r => r.id === id);
      if (!room) return alert("Sala no encontrada.");
      if (room.participants >= MAX_PARTICIPANTS) return alert("Sala llena.");

      // Simular usuario Ãºnico con ID generado (puedes adaptar)
      const userId = "user_" + Math.floor(Math.random() * 1000000);

      // Agregar participante
      room.participants++;
      room.participantsList.push(userId);

      // Mostrar detalles de la sala y activar la rueda
      openRoomDetail(room);
    }

    // Abrir vista detalle sala
    function openRoomDetail(room) {
      currentRoom = room;
      spinCount = 0;
      spinning = false;
      document.getElementById("roomTitle").textContent = `Sala #${room.id}`;
      document.getElementById("participantCount").textContent = `${room.participants} / ${MAX_PARTICIPANTS}`;
      document.getElementById("winnerAnnounce").innerHTML = "";
      document.getElementById("spinButton").disabled = false;
      document.getElementById("rooms").parentElement.style.display = "none";
      document.getElementById("roomDetail").classList.remove("hidden");
      resetWheel();
    }

    // Volver a la lista de salas
    document.getElementById("backToRooms").onclick = () => {
      currentRoom = null;
      spinning = false;
      document.getElementById("roomDetail").classList.add("hidden");
      document.getElementById("rooms").parentElement.style.display = "block";
      renderRooms();
    };

    // Rueda
    const wheel = document.getElementById("wheel");
    const spinBtn = document.getElementById("spinButton");
    const winnerAnnounce = document.getElementById("winnerAnnounce");

    // Resetear rueda a 0Â°
    function resetWheel() {
      wheel.style.transition = "none";
      wheel.style.transform = `rotate(0deg)`;
    }

    // Ãngulos para segmentos (5 segmentos = 72 grados cada uno)
    // Pero usaremos 5 colores/sectores para el diseÃ±o y 3 premios asignados a 3 sectores (0-72, 72-144, 144-216)
    // Vamos a simplificar: los premios estÃ¡n en 3 sectores consecutivos para que no haya confusiÃ³n

    // Girar la rueda con efecto y seleccionar ganador
    function spinWheel() {
      if (spinning) return;
      spinning = true;
      spinBtn.disabled = true;
      spinCount++;

      // Elegir premio basado en spinCount (1,2,3) cÃ­clico
      let prizeIndex = (spinCount - 1) % PRIZES.length;
      let prizeAmount = PRIZES[prizeIndex];

      // Elegir un Ã¡ngulo aleatorio dentro del sector premio
      // Sectores:
      // Sector 1: 0-72 grados => premio 10$
      // Sector 2: 72-144 grados => premio 10$
      // Sector 3: 144-216 grados => premio 50$
      // Los otros sectores no tienen premio (simulamos solo 3 premios en 3 sectores)

      const sectorAngles = [
        {start: 0, end: 72},
        {start: 72, end: 144},
        {start: 144, end: 216}
      ];

      // Calculamos Ã¡ngulo final de giro para que el puntero quede en premio deseado
      // Vamos a girar la rueda muchas vueltas + Ã¡ngulo aleatorio dentro sector
      const fullRotations = 8; // vueltas completas para animaciÃ³n
      const sector = sectorAngles[prizeIndex];
      const randomAngleInSector = Math.floor(Math.random() * (sector.end - sector.start)) + sector.start;
      const finalAngle = fullRotations * 360 + (360 - randomAngleInSector); // invertimos para que puntero quede en sector

      wheel.style.transition = `transform 7s cubic-bezier(0.33, 1, 0.68, 1)`;
      wheel.style.transform = `rotate(${finalAngle}deg)`;

      // DespuÃ©s de la animaciÃ³n, mostrar ganador
      setTimeout(() => {
        showWinner(prizeAmount);
      }, SPIN_DELAY);
    }

    // Mostrar ganador en UI y registrar
    function showWinner(amount) {
      // Elegir ganador aleatorio de la sala
      if (!currentRoom || currentRoom.participantsList.length === 0) {
        winnerAnnounce.innerHTML = "No hay participantes.";
        resetAfterSpin();
        return;
      }
      const winnerIndex = Math.floor(Math.random() * currentRoom.participantsList.length);
      const winnerId = currentRoom.participantsList[winnerIndex];

      // Mostrar mensaje ganador
      winnerAnnounce.innerHTML = `<div class="winner-anim">ðŸŽ‰ Ganador: <strong>${winnerId}</strong> ðŸŽ‰<br>Premio: $${amount.toFixed(2)}</div>`;

      // Guardar en tabla de ganadores
      winners.unshift({
        room: currentRoom.id,
        winner: winnerId,
        prize: amount,
        date: new Date().toLocaleString()
      });

      renderWinnersTable();

      // Reseteamos la rueda tras un tiempo y si es el 3er giro, cerramos la sala
      setTimeout(() => {
        if (spinCount >= 3) {
          alert(`Sorteo en Sala #${currentRoom.id} finalizado. La sala se cerrarÃ¡.`);
          closeRoom(currentRoom.id);
          backToRooms();
        } else {
          resetAfterSpin();
        }
      }, WINNER_DISPLAY_TIME);
    }

    // Reset despuÃ©s de giro para siguiente giro
    function resetAfterSpin() {
      resetWheel();
      spinBtn.disabled = false;
      spinning = false;
      document.getElementById("participantCount").textContent = `${currentRoom.participants} / ${MAX_PARTICIPANTS}`;
      winnerAnnounce.innerHTML = "";
    }

    // Cerrar sala (vaciar participantes y bloquear)
    function closeRoom(id) {
      const room = rooms.find(r => r.id === id);
      if (room) {
        room.participants = MAX_PARTICIPANTS;
        room.participantsList = [];
      }
    }

    // Render tabla ganadores
    function renderWinnersTable() {
      const tbody = document.getElementById("winnersTableBody");
      tbody.innerHTML = "";
      if (winners.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 p-4">No hay ganadores aÃºn.</td></tr>`;
        return;
      }
      for (const w of winners) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border border-gray-600 p-2">Sala #${w.room}</td>
          <td class="border border-gray-600 p-2">${w.winner}</td>
          <td class="border border-gray-600 p-2">$${w.prize.toFixed(2)}</td>
          <td class="border border-gray-600 p-2">${w.date}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // FunciÃ³n para volver a lista de salas desde detalle
    function backToRooms() {
      currentRoom = null;
      spinning = false;
      document.getElementById("roomDetail").classList.add("hidden");
      document.getElementById("rooms").parentElement.style.display = "block";
      renderRooms();
    }

    // BotÃ³n girar rueda
    spinBtn.onclick = () => {
      spinWheel();
    };

    // InicializaciÃ³n
    createRooms();
    renderRooms();
    renderWinnersTable();
  </script>
</body>
</html>
