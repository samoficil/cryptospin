import React, { useState, useEffect, useRef } from "react";

// Configuraciones base
const SECTORES = 200;
const COLORES = ["#FFD700", "#FF4500", "#1E90FF", "#32CD32"]; // amarillo, rojo, azul, verde
const GIROS_TOTALES = 3;

function Wheel({ onNewWinner }) {
  const [girando, setGirando] = useState(false);
  const [rotacion, setRotacion] = useState(0);
  const [ganador, setGanador] = useState(null);
  const [giroCount, setGiroCount] = useState(0);
  const animFrameRef = useRef(null);

  const anguloPorSector = 360 / SECTORES;

  // Girar la rueda
  const girarRueda = () => {
    if (girando || giroCount >= GIROS_TOTALES) return;

    setGirando(true);
    setGanador(null);

    const ganadorNum = Math.floor(Math.random() * SECTORES) + 1;
    const vueltas = 5 * 360;
    const rotacionFinal = vueltas + (360 - ganadorNum * anguloPorSector);

    let start = null;
    const duracion = 20000;

    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    const animar = (timestamp) => {
      if (!start) start = timestamp;
      const elapsed = timestamp - start;
      const progreso = Math.min(elapsed / duracion, 1);
      const easeProgress = easeOutCubic(progreso);

      setRotacion(easeProgress * rotacionFinal);

      if (elapsed < duracion) {
        animFrameRef.current = requestAnimationFrame(animar);
      } else {
        setGirando(false);
        setGanador(ganadorNum);
        setGiroCount((c) => c + 1);
        onNewWinner(ganadorNum);

        if (giroCount < GIROS_TOTALES - 1) {
          setTimeout(() => {
            girarRueda();
          }, 7000);
        }
      }
    };

    animFrameRef.current = requestAnimationFrame(animar);
  };

  useEffect(() => {
    return () => cancelAnimationFrame(animFrameRef.current);
  }, []);

  // Generar sectores SVG
  const sectoresSVG = [];
  for (let i = 0; i < SECTORES; i++) {
    const startAngle = i * anguloPorSector;
    const endAngle = startAngle + anguloPorSector;
    const largeArcFlag = anguloPorSector > 180 ? 1 : 0;

    const x1 = 150 + 150 * Math.cos((Math.PI * startAngle) / 180);
    const y1 = 150 + 150 * Math.sin((Math.PI * startAngle) / 180);
    const x2 = 150 + 150 * Math.cos((Math.PI * endAngle) / 180);
    const y2 = 150 + 150 * Math.sin((Math.PI * endAngle) / 180);

    const pathData = `
      M150,150
      L${x1},${y1}
      A150,150 0 ${largeArcFlag} 1 ${x2},${y2}
      Z
    `;

    sectoresSVG.push(
      <path
        key={i}
        d={pathData}
        fill={COLORES[i % COLORES.length]}
        stroke="#fff"
        strokeWidth="0.5"
      />
    );

    const textAngle = startAngle + anguloPorSector / 2;
    const textX = 150 + 100 * Math.cos((Math.PI * textAngle) / 180);
    const textY = 150 + 100 * Math.sin((Math.PI * textAngle) / 180);

    sectoresSVG.push(
      <text
        key={`text-${i}`}
        x={textX}
        y={textY}
        fill="#000"
        fontSize="8"
        fontWeight="bold"
        textAnchor="middle"
        alignmentBaseline="middle"
        transform={`rotate(${textAngle + 90}, ${textX}, ${textY})`}
      >
        {i + 1}
      </text>
    );
  }

  return (
    <div style={{ userSelect: "none" }}>
      <svg
        width="300"
        height="300"
        style={{
          transform: `rotate(${rotacion}deg)`,
          transition: girando ? "none" : "transform 0.5s ease-out",
          borderRadius: "50%",
          border: "5px solid #444",
          boxShadow: "0 0 15px rgba(0,0,0,0.2)",
          background: "#fff",
          display: "block",
          margin: "0 auto",
        }}
        viewBox="0 0 300 300"
      >
        {sectoresSVG}
      </svg>
      <button
        onClick={girando ? null : girarRueda}
        disabled={girando || giroCount >= GIROS_TOTALES}
        style={{
          padding: "10px 20px",
          fontSize: "18px",
          cursor: girando || giroCount >= GIROS_TOTALES ? "not-allowed" : "pointer",
          marginTop: 10,
          display: "block",
          marginLeft: "auto",
          marginRight: "auto",
        }}
      >
        {girando
          ? "Girando..."
          : giroCount >= GIROS_TOTALES
          ? "Juego terminado"
          : "Girar Rueda"}
      </button>
      {ganador && (
        <div
          style={{
            marginTop: 20,
            fontSize: 24,
            fontWeight: "bold",
            color: "#d9534f",
            textAlign: "center",
            animation: "aplausos 1s ease-in-out infinite",
          }}
        >
          🎉 ¡Número Ganador: {ganador}! 👏👏👏
          <br />
          <span role="img" aria-label="aplausos">
            👏👏👏🎉🎉🎉
          </span>
        </div>
      )}
      <style>{`
        @keyframes aplausos {
          0%, 100% {opacity:1;}
          50% {opacity:0.6;}
        }
      `}</style>
    </div>
  );
}

function App() {
  // Simulamos salas con nombre y participantes
  const [salas, setSalas] = useState(() =>
    Array.from({ length: 10 }, (_, i) => ({
      id: i + 1,
      nombre: `Sala #${i + 1}`,
      participantes: 0,
      maxParticipantes: 200,
      ganadores: [],
    }))
  );

  const [busqueda, setBusqueda] = useState("");
  const [usuario, setUsuario] = useState(null);
  const [saldo, setSaldo] = useState(0);
  const [registro, setRegistro] = useState({ email: "", password: "" });
  const [errorRegistro, setErrorRegistro] = useState("");
  const [salaActiva, setSalaActiva] = useState(null);

  // Ganadores diarios y semanales (simulados)
  const [ganadoresDiarios, setGanadoresDiarios] = useState([]);
  const [ganadoresSemanales, setGanadoresSemanales] = useState([]);

  // Filtrar salas por búsqueda y que no estén llenas
  const salasFiltradas = salas.filter(
    (s) =>
      s.nombre.toLowerCase().includes(busqueda.toLowerCase()) &&
      s.participantes < s.maxParticipantes
  );

  // Al registrar nuevo usuario (sin backend real)
  const registrar = () => {
    if (!registro.email.includes("@") || registro.password.length < 6) {
      setErrorRegistro("Email inválido o contraseña < 6 caracteres");
      return;
    }
    setUsuario({ email: registro.email });
    setSaldo(0);
    setErrorRegistro("");
  };

  // Usuario compra números en sala (cada número cuesta $0.50)
  const comprarNumeros = (cantidad) => {
    const costo = 0.5 * cantidad;
    if (saldo < costo) {
      alert("Saldo insuficiente, recarga primero.");
      return;
    }
    if (!salaActiva) {
      alert("Selecciona una sala primero");
      return;
    }
    // Sumar participantes en la sala
    setSalas((prev) =>
      prev.map((s) =>
        s.id === salaActiva.id
          ? {
              ...s,
              participantes: Math.min(s.participantes + cantidad, s.maxParticipantes),
            }
          : s
      )
    );
    setSaldo((s) => s - costo);
    alert(`Compraste ${cantidad} números en ${salaActiva.nombre}`);
  };

  // Recargar saldo mínimo $2 (simulado)
  const recargarSaldo = () => {
    setSaldo((s) => s + 2);
    alert("Recarga de $2 realizada");
  };

  // Cuando la rueda elige ganador
  const onNewWinner = (numero) => {
    if (!salaActiva) return;

    const ganador = { numero, fecha: new Date().toLocaleString() };

    setGanadoresDiarios((prev) => [ganador, ...prev].slice(0, 20));
    setGanadoresSemanales((prev) => [ganador, ...prev].slice(0, 20));

    // Guardar ganador en sala
    setSalas((prev) =>
      prev.map((s) =>
        s.id === salaActiva.id ? { ...s, ganadores: [ganador, ...s.ganadores].slice(0, 10) } : s
      )
    );
  };

  return (
    <div style={{ maxWidth: 800, margin: "auto", fontFamily: "Arial, sans-serif", padding: 20 }}>
      <h1 style={{ textAlign: "center" }}>🎡 Rueda de Números - React Completo</h1>

      {!usuario ? (
        <div
          style={{
            border: "1px solid #ccc",
            padding: 20,
            borderRadius: 8,
            maxWidth: 400,
            margin: "auto",
          }}
        >
          <h2>Registro</h2>
          <input
            type="email"
            placeholder="Email"
            value={registro.email}
            onChange={(e) => setRegistro({ ...registro, email: e.target.value })}
            style={{ width: "100%", padding: 8, marginBottom: 10, fontSize: 16 }}
          />
          <input
            type="password"
            placeholder="Contraseña (mín 6 caracteres)"
            value={registro.password}
            onChange={(e) => setRegistro({ ...registro, password: e.target.value })}
            style={{ width: "100%", padding: 8, marginBottom: 10, fontSize: 16 }}
          />
          {errorRegistro && <p style={{ color: "red" }}>{errorRegistro}</p>}
          <button
            onClick={registrar}
            style={{
              width: "100%",
              padding: 10,
              fontSize: 18,
              cursor: "pointer",
              backgroundColor: "#28a745",
              color: "#fff",
              border: "none",
              borderRadius: 5,
            }}
          >
            Registrarse
          </button>
        </div>
      ) : (
        <>
          <div style={{ textAlign: "right", marginBottom: 20 }}>
            <b>Usuario:</b> {usuario.email} | <b>Saldo:</b> ${saldo.toFixed(2)}{" "}
            <button onClick={recargarSaldo} style={{ marginLeft: 10 }}>
              Recargar $2
            </button>
          </div>

          {/* Buscador y lista salas */}
          <div style={{ marginBottom: 20 }}>
            <input
              type="text"
              placeholder="Buscar sala..."
              value={busqueda}
              onChange={(e) => setBusqueda(e.target.value)}
              style={{ width: "100%", padding: 10, fontSize: 16 }}
            />
            <div
              style={{
                maxHeight: 150,
                overflowY: "auto",
                marginTop: 10,
                border: "1px solid #ccc",
                borderRadius: 5,
              }}
            >
              {salasFiltradas.length === 0 && <p style={{ padding: 10 }}>No hay salas disponibles</p>}
              {salasFiltradas.map((s) => (
                <div
                  key={s.id}
                  onClick={() => setSalaActiva(s)}
                  style={{
                    padding: 10,
                    cursor: "pointer",
                    backgroundColor: salaActiva?.id === s.id ? "#007bff" : "transparent",
                    color: salaActiva?.id === s.id ? "#fff" : "#000",
                    borderBottom: "1px solid #ddd",
                  }}
                >
                  {s.nombre} - Participantes: {s.participantes}/{s.maxParticipantes}
                </div>
              ))}
            </div>
          </div>

          {/* Comprar números */}
          {salaActiva && (
            <div style={{ marginBottom: 20 }}>
              <h3>
                Sala activa: <span style={{ color: "#007bff" }}>{salaActiva.nombre}</span>
              </h3>
              <button
                onClick={() => comprarNumeros(1)}
                style={{ marginRight: 10, padding: "8px 15px", fontSize: 16 }}
              >
                Comprar 1 número ($0.50)
              </button>
              <button
                onClick={() => comprarNumeros(5)}
                style={{ marginRight: 10, padding: "8px 15px", fontSize: 16 }}
              >
                Comprar 5 números ($2.50)
              </button>
              <button
                onClick={() => comprarNumeros(10)}
                style={{ padding: "8px 15px", fontSize: 16 }}
              >
                Comprar 10 números ($5.00)
              </button>
            </div>
          )}

          {/* Rueda */}
          <Wheel onNewWinner={onNewWinner} />

          {/* Ganadores */}
          <div style={{ marginTop: 30 }}>
            <h2>Ganadores Diarios</h2>
            <ul style={{ maxHeight: 150, overflowY: "auto" }}>
              {ganadoresDiarios.length === 0 && <li>No hay ganadores aún</li>}
              {ganadoresDiarios.map((g, i) => (
                <li key={i}>
                  Número: <b>{g.numero}</b> | Hora: {g.fecha}
                </li>
              ))}
            </ul>

            <h2>Ganadores Semanales</h2>
            <ul style={{ maxHeight: 150, overflowY: "auto" }}>
              {ganadoresSemanales.length === 0 && <li>No hay ganadores aún</li>}
              {ganadoresSemanales.map((g, i) => (
                <li key={i}>
                  Número: <b>{g.numero}</b> | Hora: {g.fecha}
                </li>
              ))}
            </ul>
          </div>
        </>
      )}
    </div>
  );
}

export default App;
