<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoSpin - Sorteos en Cripto</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    canvas {
      background: #222;
      border-radius: 50%;
      box-shadow: 0 0 15px #0f0;
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <header class="p-4 bg-gray-800 text-center text-2xl font-bold">CryptoSpin</header>

  <main class="p-6">
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Bienvenido a CryptoSpin</h2>
      <p>Participa en salas de sorteo automáticas y gana premios en criptomonedas.</p>
    </section>

    <!-- Buscador de salas -->
    <div class="mb-6">
      <input
        type="text"
        id="searchInput"
        placeholder="Buscar sala por número..."
        class="w-full p-2 rounded text-black"
      />
    </div>

    <section id="rooms" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></section>
  </main>

  <footer class="p-4 bg-gray-800 text-center">&copy; 2025 CryptoSpin. Todos los derechos reservados.</footer>

  <script>
    const roomsContainer = document.getElementById("rooms");
    const searchInput = document.getElementById("searchInput");

    const segments = 200;
    const segmentAngle = (2 * Math.PI) / segments;
    const radius = 200;

    const roomsData = [];

    // Crear salas
    function createRoom(id, participants = 0) {
      const room = document.createElement("div");
      room.className = "bg-gray-700 rounded-xl p-4 shadow-xl room";
      room.setAttribute("data-id", id);
      room.setAttribute("data-participants", participants);

      room.innerHTML = `
        <h3 class="text-lg font-bold mb-2">Sala #${id}</h3>
        <p>Participantes: <span class="participant-count">${participants}</span> / 200</p>
        <button class="join-btn mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">
          Unirse por $0.50
        </button>
        <div class="wheel-container mt-4"></div> <!-- Aquí va la rueda y resultado -->
      `;

      roomsContainer.appendChild(room);
      roomsData.push({ id, participants });

      // Evento botón unirse
      room.querySelector(".join-btn").addEventListener("click", () => joinRoom(id));
    }

    // Rellenar salas
    function populateRooms() {
      for (let i = 1; i <= 10; i++) {
        const randomParticipants = Math.floor(Math.random() * 200);
        if (randomParticipants < 200) {
          createRoom(i, randomParticipants);
        }
      }
    }

    // Color por segmento
    function getColor(i) {
      return i % 2 === 0 ? "#0f0" : "#050";
    }

    // Función para dibujar la rueda en un canvas dado
    function drawWheel(ctx, currentAngle) {
      ctx.clearRect(0, 0, radius * 2 + 40, radius * 2 + 40);
      ctx.save();
      ctx.translate(radius + 20, radius + 20);
      ctx.rotate(currentAngle);

      for (let i = 0; i < segments; i++) {
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.fillStyle = getColor(i);
        ctx.arc(0, 0, radius, i * segmentAngle, (i + 1) * segmentAngle);
        ctx.fill();
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 0.3;
        ctx.stroke();

        ctx.save();
        ctx.fillStyle = "white";
        ctx.translate(
          Math.cos(i * segmentAngle + segmentAngle / 2) * (radius - 25),
          Math.sin(i * segmentAngle + segmentAngle / 2) * (radius - 25)
        );
        ctx.rotate(i * segmentAngle + segmentAngle / 2 + Math.PI / 2);
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.fillText(i + 1, 0, 0);
        ctx.restore();
      }

      ctx.restore();

      // Flecha indicadora fija arriba
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.moveTo(radius + 20 - 15, 10);
      ctx.lineTo(radius + 20 + 15, 10);
      ctx.lineTo(radius + 20, 40);
      ctx.closePath();
      ctx.fill();
    }

    // Girar rueda con desaceleración lenta y duración 20s
    function spinWheel(canvas, resultDiv) {
      if (canvas.spinning) return;
      canvas.spinning = true;
      resultDiv.textContent = "";

      const ctx = canvas.getContext("2d");
      let currentAngle = 0;

      const duration = 20000; // 20 segundos
      const suspenseDuration = 5000; // últimos 5 segundos lentos
      const start = performance.now();

      const maxAngularVelocity = 0.6;
      const minAngularVelocity = 0.01;

      function animate(time) {
        const elapsed = time - start;

        if (elapsed >= duration) {
          canvas.spinning = false;
          const normalizedAngle = currentAngle % (2 * Math.PI);
          let winningIndex = Math.floor((segments - normalizedAngle / segmentAngle)) % segments;
          if (winningIndex < 0) winningIndex += segments;

          resultDiv.textContent = `¡Ganador: Segmento #${winningIndex + 1}!`;
          return;
        }

        let angularVelocity;
        if (elapsed < duration - suspenseDuration) {
          angularVelocity = maxAngularVelocity * (1 - elapsed / (duration - suspenseDuration));
        } else {
          const suspenseElapsed = elapsed - (duration - suspenseDuration);
          const t = suspenseElapsed / suspenseDuration;
          angularVelocity = minAngularVelocity + (maxAngularVelocity - minAngularVelocity) * (1 - t) * (1 - t);
        }

        currentAngle += angularVelocity;
        drawWheel(ctx, currentAngle);

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);
    }

    // Lógica para unirse a sala y mostrar la rueda dentro de esa sala
    function joinRoom(id) {
      const roomEl = document.querySelector(`.room[data-id='${id}']`);
      if (!roomEl) return;

      // Actualizar participantes
      const participantCountEl = roomEl.querySelector(".participant-count");
      let count = parseInt(participantCountEl.textContent);
      if (count >= 200) {
        alert("La sala está llena");
        return;
      }
      count++;
      participantCountEl.textContent = count;

      // Actualizar en roomsData también
      const roomData = roomsData.find(r => r.id === id);
      if (roomData) roomData.participants = count;

      alert(`Te has unido a la Sala #${id}`);

      // Crear canvas y resultado si no existen
      const wheelContainer = roomEl.querySelector(".wheel-container");
      wheelContainer.innerHTML = ""; // Limpiar para reiniciar

      const canvas = document.createElement("canvas");
      canvas.width = radius * 2 + 40;
      canvas.height = radius * 2 + 40;
      canvas.style.margin = "0 auto";
      canvas.style.display = "block";

      const resultDiv = document.createElement("div");
      resultDiv.style.textAlign = "center";
      resultDiv.style.marginTop = "10px";
      resultDiv.style.fontWeight = "bold";
      resultDiv.style.fontSize = "1.5rem";

      wheelContainer.appendChild(canvas);
      wheelContainer.appendChild(resultDiv);

      // Empezar el giro
      spinWheel(canvas, resultDiv);
    }

    // Filtrar salas
    searchInput.addEventListener("input", (e) => {
      const value = e.target.value.toLowerCase();
      document.querySelectorAll(".room").forEach(room => {
        const roomId = room.getAttribute("data-id");
        room.style.display = roomId.includes(value) ? "block" : "none";
      });
    });

    populateRooms();
  </script>
</body>
</html>
