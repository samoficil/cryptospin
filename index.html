<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoSpin - Sorteos en Cripto</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Mejor que texto pequeño para 200 segmentos, vamos a usar texto más pequeño */
    canvas {
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <header class="p-4 bg-gray-800 text-center text-2xl font-bold">CryptoSpin</header>

  <main class="p-6">

    <section id="roomsSection" class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Salas disponibles</h2>
      <div id="rooms" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <section id="wheelContainer" style="display:none; text-align:center;">
      <canvas id="wheel" width="600" height="600" class="mx-auto rounded-lg shadow-lg bg-white"></canvas>
      <button id="spinButton" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full">Girar rueda</button>
      <div id="result" class="mt-6 text-green-400 text-2xl font-bold"></div>
    </section>

  </main>

  <footer class="p-4 bg-gray-800 text-center">&copy; 2025 CryptoSpin. Todos los derechos reservados.</footer>

  <script>
    const roomsContainer = document.getElementById("rooms");
    const roomsSection = document.getElementById("roomsSection");
    const wheelContainer = document.getElementById("wheelContainer");
    const spinButton = document.getElementById("spinButton");
    const resultDiv = document.getElementById("result");

    const MAX_PARTICIPANTS = 200;

    // Crear salas iguales al ejemplo
    function createRoom(id, participants = 0) {
      const room = document.createElement("div");
      room.className = "bg-gray-700 rounded-xl p-4 shadow-xl";
      room.setAttribute("data-id", id);
      room.setAttribute("data-participants", participants);

      room.innerHTML = `
        <h3 class="text-lg font-bold mb-2">Sala #${id}</h3>
        <p>Participantes: <span class="participant-count">${participants}</span> / ${MAX_PARTICIPANTS}</p>
        <button class="join-btn mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Unirse por $0.50</button>
      `;

      roomsContainer.appendChild(room);

      room.querySelector(".join-btn").onclick = () => onJoinClick(id);
    }

    function populateRooms() {
      roomsContainer.innerHTML = "";
      for (let i = 1; i <= 10; i++) {
        const randomParticipants = Math.floor(Math.random() * MAX_PARTICIPANTS);
        createRoom(i, randomParticipants);
      }
    }

    function onJoinClick(roomId) {
      roomsSection.style.display = "none";
      wheelContainer.style.display = "block";
      resultDiv.textContent = "";
      currentAngle = 0;
      angularVelocity = 0;
      spinning = false;
      drawWheel();
    }

    // --- Rueda ---

    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const center = size / 2;

    const segments = 200; // Ahora 200 segmentos
    const segmentAngle = (2 * Math.PI) / segments;
    const colors = ['#22c55e', '#16a34a']; // colores alternos

    let currentAngle = 0;
    let angularVelocity = 0;
    let spinning = false;

    function drawWheel() {
      ctx.clearRect(0, 0, size, size);

      for (let i = 0; i < segments; i++) {
        const startAngle = currentAngle + i * segmentAngle;
        const endAngle = startAngle + segmentAngle;

        ctx.fillStyle = colors[i % colors.length];

        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.arc(center, center, center - 20, startAngle, endAngle);
        ctx.lineTo(center, center);
        ctx.fill();

        // Texto del número (más pequeño)
        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(startAngle + segmentAngle / 2);
        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.textAlign = 'right';
        ctx.fillText(i + 1, center - 10, 4);
        ctx.restore();
      }

      // Flecha indicadora
      ctx.fillStyle = '#f87171';
      ctx.beginPath();
      ctx.moveTo(center - 15, 10);
      ctx.lineTo(center + 15, 10);
      ctx.lineTo(center, 40);
      ctx.closePath();
      ctx.fill();
    }

    function spin() {
      if (spinning) return;
      spinning = true;
      spinButton.disabled = true;
      resultDiv.textContent = "";

      // Para durar 20 segundos, usamos tiempo y desaceleración constantes
      const duration = 20000; // ms
      const start = performance.now();

      // velocidad inicial muy alta para 200 segmentos, 10 vueltas aprox
      const initialAngularVelocity = 0.6; // rad/frame aprox (ajustable)
      
      function animate(time) {
        const elapsed = time - start;
        if (elapsed >= duration) {
          spinning = false;
          angularVelocity = 0;

          // Calcular ganador
          const normalizedAngle = currentAngle % (2 * Math.PI);
          let winningIndex = Math.floor((segments - normalizedAngle / segmentAngle)) % segments;
          if (winningIndex < 0) winningIndex += segments;

          resultDiv.textContent = `¡Ganador: Segmento #${winningIndex + 1}!`;
          spinButton.disabled = false;
          return;
        }

        // Desaceleración lineal
        angularVelocity = initialAngularVelocity * (1 - elapsed / duration);

        currentAngle += angularVelocity;
        drawWheel();

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);
    }

    spinButton.onclick = spin;

    // Inicializa
    populateRooms();
    drawWheel();

  </script>

</body>
</html>
